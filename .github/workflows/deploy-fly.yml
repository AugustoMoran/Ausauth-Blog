name: Deploy to Fly

on:
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  BACKEND_APP_NAME: ausauth-backend
  FRONTEND_APP_NAME: ausauth-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Authenticate to Fly
        run: |
          echo "${{ secrets.FLY_API_TOKEN }}" | flyctl auth token

      - name: Deploy backend
        working-directory: ./backend
        run: |
          set -e
          flyctl apps create ${{ env.BACKEND_APP_NAME }} || true
          # set secrets from GitHub (add these secrets in repo settings)
          if [ -n "${{ secrets.MONGODB_URI }}" ]; then
            flyctl secrets set MONGODB_URI="${{ secrets.MONGODB_URI }}" SECRET="${{ secrets.SECRET }}" REFRESH_SECRET="${{ secrets.REFRESH_SECRET }}" --app ${{ env.BACKEND_APP_NAME }} || true
          fi
          flyctl deploy --app ${{ env.BACKEND_APP_NAME }} --config fly.toml || true

      - name: Build and Deploy frontend
        working-directory: ./frontend
        run: |
          set -e
          npm ci
          npm run build
          flyctl apps create ${{ env.FRONTEND_APP_NAME }} || true
          flyctl deploy --app ${{ env.FRONTEND_APP_NAME }} --config fly.toml || true

      - name: Add live URLs to README and push
        env:
          BACKEND_APP: ${{ env.BACKEND_APP_NAME }}
          FRONTEND_APP: ${{ env.FRONTEND_APP_NAME }}
        run: |
          set -e
          FRONTEND_URL="https://${FRONTEND_APP}.fly.dev"
          BACKEND_URL="https://${BACKEND_APP}.fly.dev"
          echo "Adding Live URLs: $FRONTEND_URL and $BACKEND_URL to README.md"
          # Insert at the top of README.md
          awk -v f="$FRONTEND_URL" -v b="$BACKEND_URL" 'BEGIN{print "Live demo: " f "\nAPI: " b "\n"} {print}' README.md > README.new && mv README.new README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore(ci): add Fly live URLs to README" || echo "No changes to commit"
          git push origin main || echo "Push failed"
